<% const edit = typeof recipe !== "undefined"; %>
<% layout("_structure/page.eta.html", {
    title: edit ? recipe.title : h.t("create")
}) %>
<% ~includeFile("_partials/breadcrumb.eta.html", {
    h,
    breadcrumb: [
        {title: h.t("recipes"), url: h.u.recipeList()},
        ...edit ? [
            {title: recipe.title, url: h.u.recipe(recipe)},
            {title: h.t("edit"), url: h.u.recipeEdit(recipe)}
        ] : [
            {title: h.t("create"), url: h.u.recipeCreate()}
        ]
    ]
}) %>

<form method="POST">
    <div class="card mb-3">
        <div class="card-header">
            <%= h.t("recipe.form.group.basic") %>
        </div>
        <div class="card-body">
            <div class="mb-3">
                <label for="title" class="form-label">
                    <%= h.t("title") %> *
                </label>
                <input class="form-control" id="title" name="title" required value="<%= edit ? recipe.title || "" : "" %>">
            </div>
            <div class="mb-3">
                <label for="description" class="form-label">
                    <%= h.t("description") %>
                </label>
                <textarea class="form-control" id="description" name="description"><%= edit ? recipe.description || "" : "" %></textarea>
            </div>
            <div class="mb-3">
                <label for="source" class="form-label">
                    <%= h.t("recipe.source") %>
                </label>
                <input class="form-control" id="source" name="source" value="<%= edit ? recipe.source || "" : "" %>">
            </div>
            <!-- TODO thumbnail -->
            <div>
                <label for="yield" class="form-label">
                    <%= h.t("recipe.yield") %>
                </label>
                <input type="number" min="1" class="form-control" id="yield" name="yield" value="<%= edit ? recipe.yield || "" : "" %>">
            </div>
        </div>
    </div>

    <div class="card mb-3">
        <div class="card-header">
            <%= h.t("recipe.form.group.nutrition") %>
        </div>
        <div class="card-body">
            <div class="row gy-3">
                <div class="col-lg-2">
                    <label for="nutritionCalories" class="form-label">
                        <%= h.t("recipe.nutrition.calories") %>
                    </label>
                    <input class="form-control" id="nutritionCalories" name="nutritionCalories" value="<%= edit ? recipe.nutritionCalories || "" : "" %>">
                </div>
                <div class="col-lg-2">
                    <label for="nutritionCarbohydrate" class="form-label">
                        <%= h.t("recipe.nutrition.carbohydrate") %>
                    </label>
                    <input class="form-control" id="nutritionCarbohydrate" name="nutritionCarbohydrate" value="<%= edit ? recipe.nutritionCarbohydrate || "" : "" %>">
                </div>
                <div class="col-lg-2">
                    <label for="nutritionCholesterol" class="form-label">
                        <%= h.t("recipe.nutrition.cholesterol") %>
                    </label>
                    <input class="form-control" id="nutritionCholesterol" name="nutritionCholesterol" value="<%= edit ? recipe.nutritionCholesterol || "" : "" %>">
                </div>
                <div class="col-lg-2">
                    <label for="nutritionFat" class="form-label">
                        <%= h.t("recipe.nutrition.fat") %>
                    </label>
                    <input class="form-control" id="nutritionFat" name="nutritionFat" value="<%= edit ? recipe.nutritionFat || "" : "" %>">
                </div>
                <div class="col-lg-2">
                    <label for="nutritionFiber" class="form-label">
                        <%= h.t("recipe.nutrition.fiber") %>
                    </label>
                    <input class="form-control" id="nutritionFiber" name="nutritionFiber" value="<%= edit ? recipe.nutritionFiber || "" : "" %>">
                </div>
                <div class="col-lg-2">
                    <label for="nutritionProtein" class="form-label">
                        <%= h.t("recipe.nutrition.protein") %>
                    </label>
                    <input class="form-control" id="nutritionProtein" name="nutritionProtein" value="<%= edit ? recipe.nutritionProtein || "" : "" %>">
                </div>
                <div class="col-lg-2">
                    <label for="nutritionSaturatedFat" class="form-label">
                        <%= h.t("recipe.nutrition.saturated_fat") %>
                    </label>
                    <input class="form-control" id="nutritionSaturatedFat" name="nutritionSaturatedFat" value="<%= edit ? recipe.nutritionSaturatedFat || "" : "" %>">
                </div>
                <div class="col-lg-2">
                    <label for="nutritionSodium" class="form-label">
                        <%= h.t("recipe.nutrition.sodium") %>
                    </label>
                    <input class="form-control" id="nutritionSodium" name="nutritionSodium" value="<%= edit ? recipe.nutritionSodium || "" : "" %>">
                </div>
                <div class="col-lg-2">
                    <label for="nutritionSugar" class="form-label">
                        <%= h.t("recipe.nutrition.sugar") %>
                    </label>
                    <input class="form-control" id="nutritionSugar" name="nutritionSugar" value="<%= edit ? recipe.nutritionSugar || "" : "" %>">
                </div>
                <div class="col-lg-2">
                    <label for="nutritionTransFat" class="form-label">
                        <%= h.t("recipe.nutrition.trans_fat") %>
                    </label>
                    <input class="form-control" id="nutritionTransFat" name="nutritionTransFat" value="<%= edit ? recipe.nutritionTransFat || "" : "" %>">
                </div>
                <div class="col-lg-2">
                    <label for="nutritionUnsaturatedFat" class="form-label">
                        <%= h.t("recipe.nutrition.unsaturated_fat") %>
                    </label>
                    <input class="form-control" id="nutritionUnsaturatedFat" name="nutritionUnsaturatedFat" value="<%= edit ? recipe.nutritionUnsaturatedFat || "" : "" %>">
                </div>
            </div>
        </div>
    </div>

    <div class="card mb-3">
        <div class="card-header">
            <%= h.t("recipe.form.group.times") %>
        </div>
        <div class="card-body">
            <!-- TODO use different widget -->
            <div class="row">
                <div class="col-sm">
                    <label for="prepTime" class="form-label">
                        <%= h.t("recipe.prep_time") %>
                    </label>
                    <input type="number" min="0" class="form-control" id="prepTime" name="prepTime" value="<%= edit ? recipe.prepTime || "" : "" %>">
                    <div class="form-text">
                        <%= h.t("recipe.form.time_hint") %>
                    </div>
                </div>
                <div class="col-sm">
                    <label for="cookTime" class="form-label">
                        <%= h.t("recipe.cook_time") %>
                    </label>
                    <input type="number" min="0" class="form-control" id="cookTime" name="cookTime" value="<%= edit ? recipe.cookTime || "" : "" %>">
                    <div class="form-text">
                        <%= h.t("recipe.form.time_hint") %>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="card mb-3">
        <div class="card-header">
            <%= h.t("recipe.form.group.ratings") %>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-sm">
                    <label for="aggregateRatingValue" class="form-label">
                        <%= h.t("recipe.aggregate_rating_value") %>
                    </label>
                    <input type="number" min="0" step=".01" class="form-control" id="aggregateRatingValue" name="aggregateRatingValue"
                           value="<%= edit ? recipe.aggregateRatingValue || "" : "" %>">
                </div>

                <div class="col-sm">
                    <label for="aggregateRatingCount" class="form-label">
                        <%= h.t("recipe.aggregate_rating_count") %>
                    </label>
                    <input type="number" min="0" class="form-control" id="aggregateRatingCount" name="aggregateRatingCount"
                           value="<%= edit ? recipe.aggregateRatingCount || "" : "" %>">
                </div>
                <div class="col-sm">
                    <label for="rating" class="form-label">
                        <%= h.t("recipe.rating") %>
                    </label>
                    <input type="number" min="0" step=".01" class="form-control" id="rating" name="rating" value="<%= edit ? recipe.rating || "" : "" %>">
                </div>
            </div>
        </div>
    </div>

    <% function arrayField(title, createBtnLabel, name, textarea, array) { %>
        <div class="card mb-3 array-field" data-array-field="<%= name %>">
            <div class="card-header">
                <%= title %>
            </div>
            <ul class="list-group list-group-flush">
                <% function renderItem(item, i, last) { %>
                    <% i = typeof i === "undefined" ? -1 : i %>
                    <% item = typeof item === "undefined" ? "" : item %>
                    <li class="list-group-item">
                        <div class="row gy-3">
                            <div class="col-sm-auto flex-grow-1">
                                <% if (textarea) { %>
                                    <textarea class="form-control me-2" title="" name="<%= name %>" required><%= item %></textarea>
                                <% } else { %>
                                    <input class="form-control me-2" title="" name="<%= name %>" required value="<%= item %>">
                                <% } %>
                            </div>

                            <div class="col-sm-auto d-flex align-items-center">
                                <div class="d-flex border-end me-2 pe-2">
                                    <button type="button" data-hook="up" class="btn btn-sm btn-outline-secondary me-1" title="<%= h.t("up") %>"<%= i === 0 ? " disabled" : "" %>>
                                        <% ~includeFile("_partials/icon.eta.html", {h, name: "arrow-up"}) %>
                                    </button>
                                    <button type="button" data-hook="down" class="btn btn-sm btn-outline-secondary" title="<%= h.t("down") %>"<%= last ? " disabled" : "" %>>
                                        <% ~includeFile("_partials/icon.eta.html", {h, name: "arrow-down"}) %>
                                    </button>
                                </div>
                                <button type="button" data-hook="delete" class="btn btn-sm btn-outline-danger me-1" title="<%= h.t("delete") %>">
                                    <% ~includeFile("_partials/icon.eta.html", {h, name: "trash"}) %>
                                </button>
                            </div>
                        </div>
                    </li>
                <% } %>
                <% array.forEach((item, i) => { %>
                    <% renderItem(item, i, i === array.length - 1) %>
                <% }) %>
                <template>
                    <% renderItem() %>
                </template>
            </ul>
            <div class="card-footer">
                <button type="button" class="btn btn-sm btn-outline-primary" data-hook="create">
                    <span class="me-2">
                        <% ~includeFile("_partials/icon.eta.html", {h, name: "plus-square"}) %>
                    </span><%= createBtnLabel %>
                </button>
            </div>
        </div>
    <% } %>

    <% arrayField(h.t("recipe.ingredients.title"), h.t("recipe.form.create_ingredient"), "ingredients", false, edit ? recipe.ingredients : []) %>
    <% arrayField(h.t("recipe.instructions"), h.t("recipe.form.create_instruction"), "instructions", true, edit ? recipe.instructions : []) %>

    <!-- TODO edit tags, reviews, history, etc. -->

    <a class="btn btn-danger me-2" href="<%= edit ? h.u.recipe(recipe) : h.u.recipeList() %>">
        <span class="me-2">
            <% ~includeFile("_partials/icon.eta.html", {h, name: "arrow-left"}) %>
        </span><%= h.t("cancel") %>
    </a>
    <button type="submit" class="btn btn-primary">
        <span class="me-2">
            <% ~includeFile("_partials/icon.eta.html", {h, name: "check-square-fill"}) %>
        </span><%= h.t("save") %>
    </button>
</form>
